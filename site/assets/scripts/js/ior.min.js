
// === Ior.js ===

const DEF_a =
  [
    'id_s',
    'region_s',
    'size_s',
    'rotate_s',
    'format_s',
  ]


class Ior    //: Image on request map class (Array of definitions)
{
  //:- server_s:   IIIF server
  //:- prefix_s:   ____ prefix


  constructor
  (
    server_s='http://127.0.0.1:8080/',
    prefix_s='assets/media/' + 'iif/'
  )
  {
    this.server_s = server_s

    this.prefix_s = prefix_s

    this.map_o = {}            //: IOR id_s dictionnary

    this
      .init__v()
}



  init__v    //: scan document for ior nodes
  ()
  {
    document
      .querySelectorAll( `[data-ior_path]` )    //: IDENT
      .forEach
      (
        ul_e =>
        {
          const id_s =
            this
              .id__s
              (
                ul_e
                  .dataset
                    .ior_path        //-- 
              )

          this
            .spot__v( id_s )
            
          this
            .legend__v
            (
              id_s,
              ul_e
            )
        }
      )
  }



  id__s
  (
    path_s    //: identifier/region/size/rotation/format
  )
  {
    const def_o = {}

    let id_s

    path_s
      .split( '/' )        //-- 
      .forEach
      (
        (
          split_s,
          at_n
        ) =>
        {
          if ( !at_n )    //: path_s first part is identifier
          {
            id_s = split_s
          }
          else            //: subsequent part are region/size/rotation/format
          {
            def_o
              [DEF_a[at_n]] = split_s
          }
        }
      )
    
      this
        .map_o
          [id_s] = def_o
      
      return id_s
  }



  spot__v
  (
    id_s
  )
  {
    const shot_a = []

    document
      .querySelectorAll( `[data-ior_spot^="${id_s}"]` )    //: SPOT shots list
      .forEach
      (
        spot_e =>
        {
          spot_e
            .querySelectorAll( `[data-ior_shot]` )    //: SHOT
            .forEach
            (
              shot_e =>
              {
                const shot_s =
                  shot_e
                    .dataset
                      .ior_shot
              
                if ( shot_s )
                {
                  shot_a
                    .push( shot_s )
                }
    
              }
            )

          this
            .map_o
              [id_s]
                .shot_a = shot_a

        }
      )
  }



  legend__v
  (
    id_s,
    ul_e
  )
  {
    const legend_a = []

    ul_e
      .querySelectorAll( 'li' )    //: legend parts
      .forEach
      (
        li_e =>
        {
          legend_a
            .push
            (
              li_e
                .innerHTML
                  .trim()
            )
        }
      )

    this
      .map_o
        [id_s]
          .legend_a = legend_a
  }



  //=== API ===
  json__s    //: get map_o as JSON
  ()
  {
    return (
      JSON
        .stringify( this.map_o )
    )
  }



  legend__a    //: get legend parts Array
  (
    id_s
  )
  {
    return (
      this
        .map_o
          [id_s]
            .legend_a
    )
  }



  shot__a    //: get shots Array
  (
    id_s
  )
  {
    return (
      this
        .map_o
          [id_s]
            .shot_a
    )
  }
}

// === IOR_o: ior.js ===
var IOR_o =
{

}


void function
()
{
  let ior_c =
    new Ior()

  const json_s =
    ior_c
      .json__s()
  
  //;console.log( json_s )

  if ( !json_s )
  {
    return
  }
  //>
  SER_o
    ['REQ_IMG__v']
    ( json_s )

  //>
  ;console.log( 'ior.js' )
}()